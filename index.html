<script>
/* === みみちゃん占い：安定版（必ず window.draw を定義） === */
(function(){
  const pick = a => a[Math.floor(Math.random()*a.length)];
  const range = n => [...Array(n).keys()];

  const TOTAL = [
    ["大吉","願いが実るサイン。大胆にいこう🌈"],
    ["大吉","タイミングが噛み合う日。直感に従って✨"],
    ["中吉","肩の力が抜けて実力発揮。笑顔で◎"],
    ["中吉","動けばチャンスが増える。小さく一歩🌟"],
    ["小吉","小さなラッキーが積み重なる日🍀"],
    ["小吉","コツコツが実を結ぶ。丁寧が鍵。"],
    ["吉","穏やかに整う。基本に忠実に🌸"],
    ["吉","縁が広がる。挨拶とお礼を大切に。"],
    ["末吉","今日は整える日。睡眠と栄養を少し多めに。"],
    ["末吉","焦らず準備。下ごしらえが未来を軽くする◎"],
    ["凶","守りの日。早めの撤退が勝ち🫶"],
    ["凶","静観が賢い選択。自己ケアに時間を。"]
  ];
  const LOVE = ["笑顔の挨拶が縁を引き寄せるよ。","返信は短く丁寧に。相手のペース尊重◎","甘えすぎ注意。まず“ありがとう”。","温かい飲み物をご一緒に。距離が縮まる。","思い込みを外して観察すると発見が。","鏡を見る回数＝魅力度UPのサイン。","今日は“聞き役”に回ると好感度UP。","髪を整えるだけで印象が3割変わる！","会えなくても丁寧な一言で安心感を。","過去より“今なにをするか”を話題に。","柔らかな香りが武器。匂いケア◎","ラッキー色を身につけて出会い運UP。","境界線はやさしく明確に。無理しない。","“また今度ね”の約束を具体的な日に。"];
  const WORK = ["午前中が勝負。重いタスクから先に！","メモ魔で段取り良く。チェックは二重で◎","頼られることで評価UP。ひと声かける。","提出前に“余白”を整えると伝わり度UP。","小さな改善提案が通りやすい日。","ToDoを3つに絞ると集中できる。","報告は“結論→理由→お願い”で時短。","姿勢を1cm伸ばすと集中力が戻るよ。","新規より既存の磨き込みが吉。","資料は図解1枚あると刺さる。","早歩き移動＝脳が冴えるブースト。","締切の30分前を“本当の締切”に設定。","メールの件名を具体に→即レス率UP。","5分だけ着手でエンジンをかける。"];
  const MONEY = ["ポイント活用で得する日。必要な物だけに◎","“安い”より“長く使える”基準で選ぶと吉。","現金を少し多めに持つと安心感が違う。","サブスクの見直しチャンス！","買うより借りる・シェアが吉。","差し入れが巡り巡って返ってくる。","価格比較は1店舗増やすだけで変わる。","財布のレシート整理で金運整う。","自販機は今日は1回まで。メリハリ◎","冷蔵庫“使い切り”で臨時収入気分。","欲しいものは“48時間ルール”で判断。","固定費の年1見直しメモをセット。","Payのポイント交換忘れにご用心。","クーポンは期限前に棚卸し。"];
  const COLORS = ["さくらピンク","ミントグリーン","ラベンダー","空色","ミルクホワイト","コーラル","ハニーイエロー","ネイビー","シャンパンゴールド","アイスグレー","ライラック","ペールベージュ","チェリーレッド","パウダーブルー"];
  const ITEMS  = ["ハンカチ","小さな鏡","お茶","イヤホン","ペン","アロマ","温かい飲み物","マスクケース","飴ちゃん","目薬","モバイルバッテリー","ハンドクリーム","ヘアゴム","リップ","ミニノート","ティッシュケース"];
  const SPOTS  = ["朝の光","緑の見える場所","静かな角席","本屋さん","神社の鳥居","カフェの窓際","きれいなトイレ","駅ホームの端","近所の公園","エレベーター前で深呼吸","階段の踊り場","図書館の入口付近","花が飾られた場所","ベンチの日なた"];
  const ADVICES = ["“3回深呼吸→微笑む”で運の流れが整うよ。","やることを3つだけ書き出し、終えたら小さくガッツポーズ。","姿勢を1cmだけ伸ばす。世界の見え方が変わる。","お礼は“具体＋即”。相手の名前を添えると最強。","15分の散歩でアイデア湧く。太陽を浴びよう。","スマホ写真を10枚消すと頭が軽くなる。","靴を拭く／磨くと足取りまで軽く。","机の角を1箇所だけ片づける→波及効果◎","“今日はここまででOK”を自分に許可する。","紙に“ありがとう”を書くと流れが良くなる。","湯船5分だけでも気分が整う。","温かい飲み物で心を戻す。"];
  const SPECIAL = {
    good: ["過去の痛みを抱えたままでも大丈夫。あなたはもう“愛され直す準備”ができています。小さな一歩で、やさしいご縁が動き出します。","笑顔に温度が戻る日。あなたの誠実さに惹かれる人が、ゆっくりと近づいています。自分を大切にして、受け取る準備を。"],
    neutral: ["焦らなくていい。今日は“整える日”。心と生活をくるっと一周、やさしく点検。整うほど、ご縁は静かに寄ってきます。","過去は“学び”に変わっています。あなたの優しさは価値。小さな自己肯定を積み上げましょう。"],
    low: ["今日は守りの日。無理せず安心を最優先に。ほんの少しの自己ケアが、明日を軽くします。","つらい記憶が顔を出したら深呼吸を3回。過去はあなたの価値を決めません。今ここから、また愛されていけます。"]
  };

  function safeParam(url,key,val){ try{ const u=new URL(url,location.href); u.searchParams.set(key,val); return u.toString(); }catch{ return url; } }

  /* ★★★ ここでグローバル公開 ★★★ */
  window.draw = function(){
    const area = document.querySelector("#resultArea");
    area.hidden = false;

    const [rank,msg] = pick(TOTAL);
    document.querySelector("#total").textContent = `${rank}　${msg}`;

    const stars = document.querySelector("#stars");
    stars.innerHTML = "";
    const level = { "大吉":5, "中吉":4, "小吉":3, "吉":3, "末吉":2, "凶":1 }[rank] || 3;
    range(level).forEach(()=>{ const t=document.createElement("span"); t.className="tag"; t.textContent="💖"; stars.appendChild(t); });

    document.querySelector("#love").textContent  = pick(LOVE);
    document.querySelector("#work").textContent  = pick(WORK);
    document.querySelector("#money").textContent = pick(MONEY);

    const lucky = document.querySelector("#lucky"); lucky.innerHTML="";
    [["🎨 カラー", pick(COLORS)], ["🎁 アイテム", pick(ITEMS)], ["📍 スポット", pick(SPOTS)]].forEach(([label,val])=>{
      const tag=document.createElement("span"); tag.className="tag"; tag.textContent=`${label}: ${val}`; lucky.appendChild(tag);
    });

    document.querySelector("#advice").textContent = pick(ADVICES);

    const box=document.querySelector("#specialBox"), msgBox=document.querySelector("#specialMsg");
    let bucket="neutral"; if(rank==="大吉"||rank==="中吉") bucket="good"; if(rank==="末吉"||rank==="凶") bucket="low";
    msgBox.textContent = pick(SPECIAL[bucket]); box.hidden = false;

    document.querySelector("#againBtn").disabled=false;
    document.querySelector("#shareBtn").disabled=false;

    const app=document.querySelector("#ctaApp"), con=document.querySelector("#ctaConsult");
    if(app) app.href = safeParam(app.href,"rank",rank);
    if(con) con.href = safeParam(con.href,"rank",rank);
  };

  // 共有ボタン
  document.addEventListener("DOMContentLoaded", ()=>{
    const sb = document.querySelector("#shareBtn");
    if(!sb) return;
    sb.addEventListener("click", async ()=>{
      const text = `❤みみちゃん占い❤\n${document.querySelector("#total").textContent}\n`
        + `💘 ${document.querySelector("#love").textContent}\n💼 ${document.querySelector("#work").textContent}\n💰 ${document.querySelector("#money").textContent}\n`
        + `🎨/🎁/📍 ${document.querySelector("#lucky").innerText}\n🪄 ${document.querySelector("#advice").textContent}\n`;
      if(navigator.share){ try{ await navigator.share({text}); }catch(e){} }
      else if(navigator.clipboard){ await navigator.clipboard.writeText(text); alert("結果をコピーしました。SNSに貼り付けてシェアできます✨"); }
      else{ prompt("結果をコピーして使ってください👇", text); }
    });
  });
})();
</script>
